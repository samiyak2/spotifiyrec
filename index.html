<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moodify üéß</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-green-500 to-green-700 min-h-screen flex items-center justify-center text-white px-4">
  <div class="bg-black bg-opacity-70 p-6 rounded-xl shadow-lg max-w-md w-full text-center">
    <h1 class="text-3xl font-bold mb-2">üéß Moodify</h1>
    <p class="mb-4 text-sm">Get personalized Spotify playlists by mood, language, and artist</p>

    <!-- Login -->
    <button id="loginBtn" class="bg-white text-black px-4 py-2 rounded mb-4 hover:bg-gray-200 transition-all">Login with Google</button>
    <p id="userInfo" class="text-xs mb-2 hidden"></p>

    <!-- Mood -->
    <p class="font-semibold mt-4 mb-2">Select Mood:</p>
    <div class="flex flex-wrap justify-center gap-2 mb-4">
      <button class="btn" onclick="setMood('happy')">Happy</button>
      <button class="btn" onclick="setMood('sad')">Sad</button>
      <button class="btn" onclick="setMood('chill')">Chill</button>
      <button class="btn" onclick="setMood('focus')">Focus</button>
      <button class="btn" onclick="setMood('romantic')">Romantic</button>
      <button class="btn" onclick="setMood('party')">Party</button>
    </div>

    <!-- Language -->
    <p class="font-semibold mb-2">Select Language:</p>
    <div class="flex flex-wrap justify-center gap-2 mb-4">
      <button class="btn" onclick="setLang('english')">English</button>
      <button class="btn" onclick="setLang('hindi')">Hindi</button>
      <button class="btn" onclick="setLang('punjabi')">Punjabi</button>
      <button class="btn" onclick="setLang('gujarati')">Gujarati</button>
    </div>

    <!-- Artist -->
    <input id="artist" type="text" placeholder="Preferred artist (optional)" class="w-full px-3 py-2 rounded text-black mb-4"/>

    <!-- Playlist Button -->
    <button onclick="getPlaylist()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-white transition">Get Playlist</button>

    <!-- Result -->
    <div id="result" class="mt-4 text-sm"></div>

    <!-- History -->
    <div id="history" class="mt-6 text-left text-xs"></div>
  </div>

  <style>
    .btn {
      background-color: #1db954;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      transition: 0.2s;
    }
    .btn:hover {
      background-color: #17a34a;
    }
  </style>

  <script type="module">
    // Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBSexom8YYS0XLvop56ImkdQwnCFRQDqw",
      authDomain: "spotifyrec-464014.firebaseapp.com",
      projectId: "spotifyrec-464014",
      storageBucket: "spotifyrec-464014.appspot.com",
      messagingSenderId: "911478887745",
      appId: "1:911478887745:web:65213ce1ec3c29dbfefdc0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let mood = "", lang = "";

    // Mood & Lang
    window.setMood = (m) => mood = m;
    window.setLang = (l) => lang = l;

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      try {
        const res = await signInWithPopup(auth, provider);
        currentUser = res.user;
        document.getElementById("userInfo").textContent = `Logged in as: ${currentUser.email}`;
        document.getElementById("userInfo").classList.remove("hidden");
        document.getElementById("loginBtn").classList.add("hidden");
        loadHistory();
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    };

    async function getPlaylist() {
      const artist = document.getElementById("artist").value;
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "‚è≥ Searching...";

      if (!mood || !lang) {
        resultDiv.innerHTML = "Please select both mood and language.";
        return;
      }

      const userId = currentUser ? currentUser.uid : "";
      const url = `https://spotrec-backend-911478887745.asia-south1.run.app/recommend?mood=${encodeURIComponent(mood)}&lang=${encodeURIComponent(lang)}&artist=${encodeURIComponent(artist)}&user=${userId}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.url) {
          resultDiv.innerHTML = `<b>${data.playlist}</b><br><a href="${data.url}" target="_blank" class="underline text-green-300">Open on Spotify</a>`;
          loadHistory();
        } else {
          resultDiv.innerHTML = "No playlist found. Try a different mood or artist.";
        }
      } catch (err) {
        resultDiv.innerHTML = "‚ùå Something went wrong. Try again.";
      }
    }

    async function loadHistory() {
      if (!currentUser) return;
      const res = await fetch(`https://spotrec-backend-911478887745.asia-south1.run.app/history?user=${currentUser.uid}`);
      const historyData = await res.json();
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = `<h3 class="font-bold text-white mb-1">Your Playlist History:</h3>` +
        historyData.map(d =>
          `<div class="mb-1">üé∂ <b>${d.playlist}</b> (${d.mood}, ${d.lang}) <a href="${d.url}" target="_blank" class="text-green-300 underline">Open</a></div>`
        ).join("") || "No history yet.";
    }

    // Auto login check
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("userInfo").textContent = `Logged in as: ${currentUser.email}`;
        document.getElementById("userInfo").classList.remove("hidden");
        document.getElementById("loginBtn").classList.add("hidden");
        loadHistory();
      }
    });
  </script>
</body>
</html>
